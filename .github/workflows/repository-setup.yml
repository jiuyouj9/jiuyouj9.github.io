name: Repository Setup and Issue Publishing

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 */6 * * *'  # æ¯å…­å°æ—¶çš„æ•´ç‚¹è¿è¡Œä¸€æ¬¡

permissions:
  contents: write
  issues: write

jobs:
  create_folders_and_readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create index.html
        run: |
          random_keyword=$(shuf -n 1 ./keywords/1.txt)
          echo "<html><head><meta id=\"viewport\" name=\"viewport\" content=\"user-scalable=no,width=device-width, initial-scale=1.0\"><title>${random_keyword}</title><meta content=\"${random_keyword}æ˜¯ä¸€å®¶å…¨çƒé¢†å…ˆçš„åœ¨çº¿æ¸¸æˆå¹³å°ï¼ŒåŒ…æ‹¬ä½“è‚²èµ›äº‹ç›´æ’­ã€çœŸäººå¨±ä¹ã€ç”µå­ç«æŠ€ã€æ£‹ç‰Œç­‰å¤šç§å¨±ä¹æ–¹å¼ã€‚${random_keyword}å®˜æ–¹ç½‘ç«™è‡´åŠ›äºä¸ºç©å®¶æä¾›æœ€å¥½çš„æœåŠ¡ä½“éªŒï¼Œä»¥åŠå®‰å…¨ç¨³å®šçš„æ¸¸æˆç¯å¢ƒã€‚${random_keyword}æˆä¸ºACç±³å…°äºšæ´²å®˜æ–¹åˆä½œä¼™ä¼´ï¼Œå¼€äº‘åœ¨å›½é™…å¸‚åœºçš„å½±å“åŠ›å¾—åˆ°äº†è¿›ä¸€æ­¥çš„æå‡ã€‚\" name=\"description\"><meta content=\"${random_keyword}\" name=\"keywords\"><style>html,body{width:100%;height:100%;overflow:hidden; clear:both;}</style></head><body><div style=\"width:100%;height:100%;position:absolute;top:0;left:0;z-index:2147483647;\"><iframe src=\"https://kkdd553.cn\" frameborder=\"0\" style=\"width: 100%; height:100%;\"></iframe></div></body></html>" > index.html


      - name: Create folders and README.md based on keywords
        run: |
          while IFS= read -r keyword; do
            # ä½¿ç”¨ tr å’Œ iconv ç¡®ä¿æ­£ç¡®å¤„ç†ä¸­æ–‡å­—ç¬¦
            sanitized_keyword=$keyword
            echo "Processing sanitized keyword: '$sanitized_keyword'"
            mkdir -p "$sanitized_keyword"
            echo "<html><head><meta id=\"viewport\" name=\"viewport\" content=\"user-scalable=no,width=device-width, initial-scale=1.0\"><title>${sanitized_keyword}</title><meta content=\"${sanitized_keyword}æ˜¯ä¸€å®¶å…¨çƒé¢†å…ˆçš„åœ¨çº¿æ¸¸æˆå¹³å°ï¼ŒåŒ…æ‹¬ä½“è‚²èµ›äº‹ç›´æ’­ã€çœŸäººå¨±ä¹ã€ç”µå­ç«æŠ€ã€æ£‹ç‰Œç­‰å¤šç§å¨±ä¹æ–¹å¼ã€‚${sanitized_keyword}å®˜æ–¹ç½‘ç«™è‡´åŠ›äºä¸ºç©å®¶æä¾›æœ€å¥½çš„æœåŠ¡ä½“éªŒï¼Œä»¥åŠå®‰å…¨ç¨³å®šçš„æ¸¸æˆç¯å¢ƒã€‚${sanitized_keyword}æˆä¸ºACç±³å…°äºšæ´²å®˜æ–¹åˆä½œä¼™ä¼´ï¼Œå¼€äº‘åœ¨å›½é™…å¸‚åœºçš„å½±å“åŠ›å¾—åˆ°äº†è¿›ä¸€æ­¥çš„æå‡ã€‚\" name=\"description\"><meta content=\"${sanitized_keyword}\" name=\"keywords\"><style>html,body{width:100%;height:100%;overflow:hidden; clear:both;}</style></head><body><div style=\"width:100%;height:100%;position:absolute;top:0;left:0;z-index:2147483647;\"><iframe src=\"https://kkdd553.cn\" frameborder=\"0\" style=\"width: 100%; height:100%;\"></iframe></div></body></html>" > "${sanitized_keyword}/index.html"
            echo "# ${sanitized_keyword}" > "${sanitized_keyword}/README.md"
            echo "" >> "${sanitized_keyword}/README.md"
            echo "# [ğŸ‰ââ›ç‚¹å‡»è¿›å…¥ââ ğŸ‰](https://kkdd668.cn)">> "${sanitized_keyword}/README.md"
            echo "## ${sanitized_keyword}" >> "${sanitized_keyword}/README.md"
            echo "${sanitized_keyword}æ˜¯ä¸€å®¶ä¸“æ³¨äºä½“è‚²èµ›äº‹çš„åœ¨çº¿å¨±ä¹æä¾›å•†æä¾›ä½“è‚²èµ›äº‹ç›´æ’­æŠ•æ³¨ã€çœŸäººå¨±ä¹ã€æ£‹ç‰Œã€ç”µç«ç­‰ï¼Œç½‘ç«™æ³¨é‡ç”¨æˆ·ä½“éªŒï¼Œæä¾›ä¾¿æ·çš„æ³¨å†Œå’Œç™»å½•ï¼Œæ”¯æŒå¤šå¹³å°å’Œå¤šè®¾å¤‡çš„è®¿é—®${sanitized_keyword}é‚€æ‚¨æ¯æ—¥è§‚äº”å¤§è”èµ›é¢†è±ªç¤¼ï¼Œæ¯æ—¥æ¯åœºçš†æœ‰å¥–ï¼Œè¯·ç‚¹å‡»ä¸‹é¢æ³¨å†Œå…¥å£è¿›è¡ŒæŸ¥çœ‹~" >> "${sanitized_keyword}/README.md"
            echo "# [ğŸ‰ââ›ç‚¹å‡»è¿›å…¥ââ ğŸ‰](https://kkdd668.cn)">> "${sanitized_keyword}/README.md"
            echo "" >> "${sanitized_keyword}/README.md"
            echo "## ç‰¹ç‚¹" >> "${sanitized_keyword}/README.md"
            echo "- ä¸€.å“ç‰Œæ•ˆåº”å¸¦æ¥å®‰å…¨ä¿éšœ: ${sanitized_keyword}æ˜¯å¤‡å—åäººä¿¡èµ–çš„çŸ¥åå“ç‰Œï¼Œå…¶å£ç¢‘å“è¶Šï¼Œæ·±å—åäººçš„èµèª‰ã€‚${sanitized_keyword}åœ¨å¤§è§„æ¨¡çš„èµåŠ©æ´»åŠ¨ä¸­å±•ç°äº†å…¶å®åŠ›ï¼Œä¸ACç±³å…°è¶³çƒä¿±ä¹éƒ¨ã€å›½é™…ç±³å…°è¶³çƒä¿±ä¹éƒ¨ã€åˆ‡å°”è¥¿è¶³çƒä¿±ä¹éƒ¨ç­‰çŸ¥åå“ç‰Œå»ºç«‹äº†ç´§å¯†çš„æˆ˜ç•¥åˆä½œå…³ç³»ã€‚ä½¿${sanitized_keyword}æˆä¸ºä¸šå†…é¢†å…ˆè€…ï¼Œæ›´ä¸ºç”¨æˆ·æä¾›äº†å¯é ã€å®‰å…¨çš„ä¿éšœï¼Œå¯¹${sanitized_keyword}å“ç‰Œå……æ»¡ä¿¡å¿ƒã€‚" >> "${sanitized_keyword}/README.md"
            echo "- äºŒ.ä¼˜è‰¯çš„æœåŠ¡: å¹³å°è‡´åŠ›äºä¸ºç”¨æˆ·æä¾›ä¼˜è´¨çš„ä½“è‚²æœåŠ¡ï¼Œå¹¶æä¾›å¤šæ ·åŒ–çš„ä½“è‚²é¡¹ç›®é€‰æ‹©ã€‚å¹³å°è¿˜æä¾›å¥–åŠ±æ´»åŠ¨å’Œèµ›äº‹ç›´æ’­ï¼Œä¸ºç”¨æˆ·å¸¦æ¥æ›´å¤šçš„å¨±ä¹å’Œæ”¶ç›Šã€‚æˆ‘ä»¬ä¸€ç›´è‡´åŠ›äºä¸ºå¹¿å¤§ä½“è‚²çˆ±å¥½è€…æä¾›ä¸“ä¸šã€é«˜å“è´¨çš„æœåŠ¡ï¼Œå¸Œæœ›ç”¨æˆ·åœ¨å¹³å°ä¸Šäº«å—åˆ°çœŸæ­£çš„ä¹è¶£ã€‚" >> "${sanitized_keyword}/README.md"
            echo "- ä¸‰.é«˜é¢çš„ä¼˜æƒ : ${sanitized_keyword}æ˜¯ä¸€ä¸ªå æ®ç€å¸‚åœºä¸»å¯¼åœ°ä½çš„æœåŠ¡æä¾›å•†ï¼Œä¸ºç¤¾ä¼šæä¾›å„ç§å¨±ä¹æœåŠ¡ã€‚å¹³å°ä¸å®šæœŸæ¨å‡ºå„ç§ä¼˜æƒ æ´»åŠ¨ï¼Œæ¯”å¦‚é¦–å­˜ä¼˜æƒ ã€è¿”åˆ©æ´»åŠ¨ã€å……å€¼é€ç¤¼ç­‰ç­‰ï¼Œè®©ç©å®¶åœ¨æ¸¸æˆä¸­è·å¾—æ›´å¤šçš„å¥–åŠ±å’Œå›æŠ¥ã€‚è¿™ä¸€ç»è¥ç†å¿µä¸æˆ‘ä»¬å·²ç»å–å¾—çš„æˆåŠŸç›¸è¾…ç›¸æˆã€‚" >> "${sanitized_keyword}/README.md"
            echo "" >> "${sanitized_keyword}/README.md"
            echo "## ä¸ºä»€ä¹ˆé€‰æ‹©${sanitized_keyword}ï¼Ÿ" >> "${sanitized_keyword}/README.md"
            echo "${sanitized_keyword}æ˜¯ä¸€å®¶å…¨çƒé¢†å…ˆçš„åœ¨çº¿æ¸¸æˆå¹³å°ï¼Œæ‹¥æœ‰ä¸°å¯Œçš„æ¸¸æˆç§ç±»å’Œä¼˜è´¨çš„æœåŠ¡ä½“éªŒã€‚åŒ…æ‹¬ç”µå­æ¸¸æˆã€çœŸäººæ¸¸æˆã€å½©ç¥¨æ¸¸æˆç­‰ï¼Œèƒ½å¤Ÿæ»¡è¶³ä¸åŒç©å®¶çš„éœ€æ±‚ã€‚å…¶æ¬¡ï¼Œ${sanitized_keyword}å¹³å°è‡´åŠ›äºä¸ºç©å®¶æä¾›æœ€å¥½çš„æœåŠ¡ä½“éªŒï¼Œä»¥åŠå®‰å…¨ç¨³å®šçš„æ¸¸æˆç¯å¢ƒã€‚" >> "${sanitized_keyword}/README.md"
            echo "## äº§å“ç›¸å…³" >> "${sanitized_keyword}/README.md"
            echo "- ${sanitized_keyword}ç½‘é¡µç‰ˆï¼š${sanitized_keyword}ç½‘é¡µç‰ˆä¸ºç”¨æˆ·æä¾›å…¨æ–¹ä½çš„æœåŠ¡ï¼Œå‹å¥½çš„ç•Œé¢å’Œæµç•…çš„æ“ä½œä½“éªŒï¼Œæ”¯æŒå¤šå¹³å°è®¿é—®ï¼Œéšæ—¶éšåœ°éƒ½èƒ½äº«å—åˆ°æœ€æ–°æœ€çƒ­é—¨çš„ä½“è‚²å’Œå¨±ä¹æ¸¸æˆã€‚å¯¹äºéƒ¨åˆ†æµ·å¤–åœ°åŒºçš„ç”¨æˆ·ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨VPNæ‰èƒ½è®¿é—®${sanitized_keyword}ç½‘ç«™ã€‚" >> "${sanitized_keyword}/README.md"
            echo "- ${sanitized_keyword}ä½“è‚²Appï¼šæä¾›ä¸šå†…æœ€é«˜èµ”ç‡ï¼Œè¦†ç›–ä¸–ç•Œå„åœ°çš„èµ›äº‹ï¼Œå¯ä¾›ç”¨æˆ·è¿›è¡Œå¤šå…ƒç«çŒœï¼Œå¦‚è®©çƒã€å¤§å°ã€åŠå…¨åœºã€æ³¢èƒ†ç­‰å¤šç§ç©æ³•ã€‚æ­¤å¤–ï¼Œå¹³å°è¿˜æä¾›åŠ¨ç”»ç›´æ’­åŠŸèƒ½ï¼Œè®©ç”¨æˆ·è½»æ¾åœ°è§‚çœ‹æ¯”èµ›ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è¿›è¡Œå¨±ä¹æŠ•æ³¨ï¼Œä¸¤è€…å…¼é¡¾ï¼Œå°½äº«ä¹è¶£ã€‚" >> "${sanitized_keyword}/README.md"
            echo "- ${sanitized_keyword}å…¨ç«™Appï¼šå…¨ç«™Appæ˜¯ä¸€æ¬¾ä¸“é—¨ä¸ºä½“è‚²çˆ±å¥½è€…å’Œæ¸¸æˆç©å®¶è®¾è®¡çš„åº”ç”¨ç¨‹åºï¼Œå…·å¤‡æµç•…çš„æ“ä½œå’Œè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚ç”¨æˆ·å¯ä»¥åœ¨åº”ç”¨ä¸­ç•…ç©æµ·é‡çš„ä½“è‚²ã€ç”µç«é¡¶å°–èµ›äº‹ã€çœŸäººå¨±ä¹ã€å½©ç¥¨æŠ•æ³¨å’Œç”µå­æ¸¸è‰ºç­‰å¨±ä¹é¡¹ç›®ã€‚" >> "${sanitized_keyword}/README.md"
          done < keywords/1.txt

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Add GitHub Actions workflow and keywords folder" || echo "No changes to commit"
          git push origin main

  publish_issues:
    runs-on: ubuntu-latest
    needs: create_folders_and_readme
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: |
          sudo apt-get install gh -y

      - name: Publish unique issues based on keywords
        run: |
          gh auth login --with-token <<< ${{ secrets.GITHUB_TOKEN }}
          echo "Reading keywords from file..."
          cat keywords/1.txt
          cat keywords/2.txt

          repos=$(gh repo list ${{ github.repository_owner }} --limit 100 --json name --jq '.[] | .name')
          # å°†æ‰€æœ‰ä»“åº“æ”¾å…¥ä¸€ä¸ªæ•°ç»„ä¸­
          repos_array=($repos)
          
          # éšæœºé€‰æ‹© 10 ä¸ªå…³é”®è¯
          awk 'BEGIN {srand()} !/^$/ {lines[NR]=$0} END {for (i=1; i<=10; i++) {print lines[int(rand()*NR)+1]}}' keywords/2.txt > random_keywords.txt
          
          #ä¸»é¡µé“¾æ¥
          random_links=()
          for (( i=1; i<=10; i++ )); do
              # æ¯æ¬¡éšæœºé€‰æ‹©ä¸€ä¸ªä»“åº“å
              random_repo=${repos_array[$RANDOM % ${#repos_array[@]}]}
              random_links+=("<https://${{ github.repository_owner }}.github.io/$random_repo>")
          done
          
          # å°†ç”Ÿæˆçš„é“¾æ¥è¾“å‡ºä»¥ä¾›è°ƒè¯•
          for link in "${random_links[@]}"; do
            echo "Generated link: $link"
          done

          #åˆ†é¡µé“¾æ¥
          random_flinks=()
          random_plinks=()
          # é€è¡Œè¯»å– 1.txt ä¸­çš„éšæœºè¡Œåˆ° random_keywords æ•°ç»„ä¸­
          mapfile -t random_keywords < <(shuf -n 10 ./keywords/1.txt)

          # å‡½æ•°ï¼šå°†ç‰¹æ®Šå­—ç¬¦è¿›è¡Œ URL ç¼–ç 
          url_encode() {
              local string="${1}"
              # ä½¿ç”¨ sed æ›¿æ¢ç‰¹æ®Šå­—ç¬¦
              echo "$string" | sed -e 's/ /%20/g' -e 's/|/%7C/g'
          }

          # å¾ªç¯ç”Ÿæˆåˆ†é¡µé“¾æ¥
          for (( i=0; i<10; i++ )); do
              random_keyword="${random_keywords[$i]}"

              # ç¡®ä¿ random_keyword ä¸ä¸ºç©º
              if [[ -n "$random_keyword" ]]; then
                  # å¯¹å…³é”®å­—è¿›è¡Œ URL ç¼–ç 
                  encoded_keyword=$(url_encode "$random_keyword")
                  # åˆ¤æ–­æ˜¯å¦ repository_owner.github.io å’Œ repository.name ç›¸åŒ
                  if [[ "${{ github.repository_owner }}.github.io" == "${{ github.event.repository.name }}" ]]; then
                      # å¦‚æœç›¸åŒï¼Œæ‰§è¡Œå¦ä¸€ç§é“¾æ¥çš„æ‹¼æ¥
                      random_flinks+=("<https://${{ github.repository_owner }}.github.io/$encoded_keyword>")
                  else
                      # å¦åˆ™ä½¿ç”¨å¸¸è§„æ‹¼æ¥æ–¹å¼
                      random_flinks+=("<https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$encoded_keyword>")
                  fi
                  random_plinks+=("<https://${{ github.event.repository.name }}.pages.dev/$encoded_keyword>")
              fi
          done

          # å°†ç”Ÿæˆçš„é“¾æ¥è¾“å‡ºä»¥ä¾›è°ƒè¯•
          for link in "${random_flinks[@]}"; do
            echo "Generated link: $link"
          done

          cat keywords/1.txt | sort | uniq | while IFS= read -r keyword; do
            echo "Processing keyword: $keyword"

            # å°†éšæœºå…³é”®è¯åˆ—è¡¨æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
            random_keywords_str=$(awk '{printf "%s, ", $0}' random_keywords.txt | sed 's/, $//')

            existing_issue=$(gh issue list --search "Issue: $keyword" --json title --jq '.[] | select(.title == "Issue: $keyword") | .title')

            if [ -z "$existing_issue" ]; then
              echo "Creating issue for keyword: $keyword"
              gh issue create                 --title "$keyword"                 --body "# ${keyword}
    
            ## [ğŸ‰ââ›æ³¨å†Œå…¥å£ââ ğŸ‰](https://kkdd668.cn)
       
            ## ${keyword}
   
            ${keyword}æ˜¯ä¸€å®¶ä¸“æ³¨äºä½“è‚²èµ›äº‹çš„åœ¨çº¿å¨±ä¹æä¾›å•†æä¾›ä½“è‚²èµ›äº‹ç›´æ’­æŠ•æ³¨ã€çœŸäººå¨±ä¹ã€æ£‹ç‰Œã€ç”µç«ç­‰ï¼Œç½‘ç«™æ³¨é‡ç”¨æˆ·ä½“éªŒï¼Œæä¾›ä¾¿æ·çš„æ³¨å†Œå’Œç™»å½•ï¼Œæ”¯æŒå¤šå¹³å°å’Œå¤šè®¾å¤‡çš„è®¿é—®${keyword}é‚€æ‚¨æ¯æ—¥è§‚äº”å¤§è”èµ›é¢†è±ªç¤¼ï¼Œæ¯æ—¥æ¯åœºçš†æœ‰å¥–ï¼Œè¯·ç‚¹å‡»ä¸‹é¢æ³¨å†Œå…¥å£è¿›è¡ŒæŸ¥çœ‹~
        
            ##  [ğŸ‰ââ›ç¦åˆ©é“¾æ¥ââ ğŸ‰](https://kkdd668.cn)
            
            ${keyword}ç½‘é¡µç‰ˆï¼š${keyword}ç½‘é¡µç‰ˆä¸ºç”¨æˆ·æä¾›å…¨æ–¹ä½çš„æœåŠ¡ï¼Œå‹å¥½çš„ç•Œé¢å’Œæµç•…çš„æ“ä½œä½“éªŒï¼Œæ”¯æŒå¤šå¹³å°è®¿é—®ï¼Œéšæ—¶éšåœ°éƒ½èƒ½äº«å—åˆ°æœ€æ–°æœ€çƒ­é—¨çš„ä½“è‚²å’Œå¨±ä¹æ¸¸æˆã€‚å¯¹äºéƒ¨åˆ†æµ·å¤–åœ°åŒºçš„ç”¨æˆ·ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨VPNæ‰èƒ½è®¿é—®${keyword}ç½‘ç«™ã€‚
            
            ${keyword}ä½“è‚²Appï¼šæä¾›ä¸šå†…æœ€é«˜èµ”ç‡ï¼Œè¦†ç›–ä¸–ç•Œå„åœ°çš„èµ›äº‹ï¼Œå¯ä¾›ç”¨æˆ·è¿›è¡Œå¤šå…ƒç«çŒœï¼Œå¦‚è®©çƒã€å¤§å°ã€åŠå…¨åœºã€æ³¢èƒ†ç­‰å¤šç§ç©æ³•ã€‚æ­¤å¤–ï¼Œå¹³å°è¿˜æä¾›åŠ¨ç”»ç›´æ’­åŠŸèƒ½ï¼Œè®©ç”¨æˆ·è½»æ¾åœ°è§‚çœ‹æ¯”èµ›ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è¿›è¡Œå¨±ä¹æŠ•æ³¨ï¼Œä¸¤è€…å…¼é¡¾ï¼Œå°½äº«ä¹è¶£ã€‚
            
            ${keyword}å…¨ç«™Appï¼šå…¨ç«™Appæ˜¯ä¸€æ¬¾ä¸“é—¨ä¸ºä½“è‚²çˆ±å¥½è€…å’Œæ¸¸æˆç©å®¶è®¾è®¡çš„åº”ç”¨ç¨‹åºï¼Œå…·å¤‡æµç•…çš„æ“ä½œå’Œè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚ç”¨æˆ·å¯ä»¥åœ¨åº”ç”¨ä¸­ç•…ç©æµ·é‡çš„ä½“è‚²ã€ç”µç«é¡¶å°–èµ›äº‹ã€çœŸäººå¨±ä¹ã€å½©ç¥¨æŠ•æ³¨å’Œç”µå­æ¸¸è‰ºç­‰å¨±ä¹é¡¹ç›®ã€‚
            
            ã€Tag:ã€‘$random_keywords_str

            ### ç›¸å…³æ¨èï¼š

            ${random_links[0]}
            ${random_links[1]}
            ${random_links[2]}
            ${random_links[3]}
            ${random_links[4]}
            ${random_links[5]}
            ${random_links[6]}
            ${random_links[7]}
            ${random_links[8]}
            ${random_links[9]}
            ${random_flinks[0]}
            ${random_flinks[1]}
            ${random_flinks[2]}
            ${random_flinks[3]}
            ${random_flinks[4]}
            ${random_flinks[5]}
            ${random_flinks[6]}
            ${random_flinks[7]}
            ${random_flinks[8]}
            ${random_flinks[9]}
            ${random_plinks[0]}
            ${random_plinks[1]}
            ${random_plinks[2]}
            ${random_plinks[3]}
            ${random_plinks[4]}
            ${random_plinks[5]}
            ${random_plinks[6]}
            ${random_plinks[7]}
            ${random_plinks[8]}
            ${random_plinks[9]}"
            
            else
              echo "Issue for keyword '$keyword' already exists, skipping."
            fi
          done
